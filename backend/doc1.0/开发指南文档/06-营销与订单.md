# 阶段 6：营销与订单服务 ✅

## 6.1 营销服务 (Promotion) — API + RPC

### Spec 文件

| 文件 | 接口数 |
|:---|:---|
| `services/promotion/api/desc/promotion.api` | 3（列表公开 / 领取+我的 JWT） |
| `services/promotion/rpc/promotion.proto` | 2（CalculateDiscount / UseCoupon） |

### Model

`db_promotion` 数据库，2 张表：

| Model 文件 | 关键方法 |
|:---|:---|
| `couponmodel.go` | FindAvailable / FindOne（缓存）/ **DecrRemainCount** |
| `couponrecordmodel.go` | Insert / FindByUserIdAndCouponId（查重）/ FindByUserId / **MarkUsed** |

### 配置

| 服务 | 端口 | 数据库 |
|:---|:---|:---|
| Promotion API | 8806 | db_promotion |
| Promotion RPC | 9905 | db_promotion |

### 业务逻辑

| Logic | 核心流程 |
|:---|:---|
| **CouponList** | 查可领优惠券（状态+库存+时间范围） |
| **CouponClaim** | 查重 → 扣减库存 → 创建领券记录 |
| **CouponMine** | 按状态查用户券 + 关联优惠券详情 |
| **CalculateDiscount (RPC)** | 校验门槛 → 计算优惠金额 |
| **UseCoupon (RPC)** | 核销优惠券 |

---

## 6.2 订单服务 (Order) — API + RPC

### Spec 文件

| 文件 | 接口数 |
|:---|:---|
| `services/order/api/desc/order.api` | 4（创建/详情/列表/取消，全部 JWT） |
| `services/order/rpc/order.proto` | 2（GetOrder / UpdateOrderStatus） |

### Model

`db_order` 数据库，2 张表：

| Model 文件 | 关键方法 |
|:---|:---|
| `ordermastermodel.go` | Insert / FindOne（缓存）/ FindByUserId（按状态分页）/ CountByUserId / **UpdateStatus** |
| `orderitemmodel.go` | Insert / FindByOrderId / CountByOrderId |

> **VARCHAR 主键**：OrderMaster 使用 `VARCHAR(64)` 作为主键（雪花 ID 格式：`SN20260212141030xxxx`）

### 配置

| 服务 | 端口 | 数据库 |
|:---|:---|:---|
| Order API | 8807 | db_order |
| Order RPC | 9906 | db_order |

### 业务逻辑

| Logic | 核心流程 |
|:---|:---|
| **CreateOrder** | 生成雪花订单号 → 写入主表+明细 → 30分钟过期 |
| **OrderDetail** | 归属校验 → 关联订单明细 |
| **OrderList** | 按状态分页 → 统计商品数 |
| **CancelOrder** | 归属校验 → 仅待支付可取消 → 状态改为4 |
| **GetOrder (RPC)** | 供 Payment/Logistics 调用 |
| **UpdateOrderStatus (RPC)** | 供 Payment 回调更新状态 |

---

## 6.3 技术要点

### ExecCtx 兼容性
go-zero v1.9.4 中 `ExecCtx` 回调签名与 `sqlc.ExecCtxFn` 不兼容，改用 `ExecNoCacheCtx` + 手动 `DelCacheCtx` 方案。

### 跨服务 RPC（待集成）
创建订单流程中的跨服务调用（Cart RPC / Product RPC / Inventory RPC / Promotion RPC）留作后续阶段集成。

---

## 6.4 构建验证

```bash
go build ./...  # ✅ 通过
```

## 6.5 文件清单

```
services/
├── promotion/
│   ├── api/
│   │   ├── desc/promotion.api           # 3 接口
│   │   ├── etc/promotion-api.yaml       # 端口 8806
│   │   └── internal/handler/promotion/  # 3 handler
│   ├── rpc/
│   │   ├── promotion.proto              # 2 RPC
│   │   ├── etc/promotion.yaml           # 端口 9905
│   │   └── internal/logic/              # 2 logic
│   └── model/
│       ├── couponmodel.go / couponrecordmodel.go / vars.go
├── order/
│   ├── api/
│   │   ├── desc/order.api               # 4 接口 (JWT)
│   │   ├── etc/order-api.yaml           # 端口 8807
│   │   └── internal/handler/order/      # 4 handler
│   ├── rpc/
│   │   ├── order.proto                  # 2 RPC
│   │   ├── etc/order.yaml               # 端口 9906
│   │   └── internal/logic/              # 2 logic
│   └── model/
│       ├── ordermastermodel.go / orderitemmodel.go / vars.go
```
