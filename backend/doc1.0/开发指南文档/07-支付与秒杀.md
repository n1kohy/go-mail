# 阶段 7：支付与秒杀服务 ✅

## 7.1 支付服务 (Payment) — API + RPC

### Spec 文件

| 文件 | 接口数 |
|:---|:---|
| `services/payment/api/desc/payment.api` | 3（回调公开 / 支付+退款 JWT） |
| `services/payment/rpc/payment.proto` | 1（GetPaymentByOrderId） |

### Model

`db_payment` 数据库，1 张表：

| Model 文件 | 关键方法 |
|:---|:---|
| `paymentflowmodel.go` | Insert / FindByOrderId / **UpdateStatus**（回调时更新） / **UpdateRefund** |

### 配置

| 服务 | 端口 | 数据库 |
|:---|:---|:---|
| Payment API | 8808 | db_payment |
| Payment RPC | 9907 | db_payment |

### 业务逻辑

| Logic | 核心流程 |
|:---|:---|
| **Pay** | 创建支付流水 → 返回模拟支付链接（后续对接支付宝/微信 SDK） |
| **PayCallback** | 验签(初版跳过) → 更新支付流水状态 → 后续调用 Order RPC |
| **Refund** | 检查支付记录 → 仅已支付可退 → 金额校验 → 更新退款状态 |
| **GetPaymentByOrderId (RPC)** | 按订单号查支付记录，供 Order 等服务调用 |

---

## 7.2 秒杀服务 (Seckill) — 仅 API

### Spec 文件

| 文件 | 接口数 |
|:---|:---|
| `services/seckill/api/desc/seckill.api` | 2（执行秒杀+查询结果，全部 JWT） |

### 配置

| 服务 | 端口 | 说明 |
|:---|:---|:---|
| Seckill API | 8809 | 连 db_inventory（后续接入 Redis+MQ） |

### 业务逻辑

| Logic | 核心流程 |
|:---|:---|
| **SeckillAction** | 初版：模拟排队响应（后续：Redis DECR 预减 → MQ 异步下单） |
| **SeckillResult** | 初版：模拟查询（后续：查 Redis seckill:result:{userId}:{skuId}） |

---

## 7.3 技术要点

### 支付对接（后续）
- 支付宝/微信 SDK 验签
- PayCallback 调用 Order RPC → `UpdateOrderStatus(已支付)`
- 退款需调用第三方退款接口

### 秒杀高并发（后续）
```
Redis DECR 预减库存 → MQ 异步 → Consumer 扣库存+创建订单
查询：Redis key = seckill:result:{userId}:{skuId}
状态：0=排队中, 1=成功, 2=失败
```

---

## 7.4 构建验证

```bash
go build ./...  # ✅ 通过
```

## 7.5 文件清单

```
services/
├── payment/
│   ├── api/
│   │   ├── desc/payment.api              # 3 接口
│   │   ├── etc/payment-api.yaml          # 端口 8808
│   │   └── internal/handler/payment/     # 3 handler
│   ├── rpc/
│   │   ├── payment.proto                 # 1 RPC
│   │   ├── etc/payment.yaml              # 端口 9907
│   │   └── internal/logic/              # 1 logic
│   └── model/
│       ├── paymentflowmodel.go / vars.go
├── seckill/
│   ├── api/
│   │   ├── desc/seckill.api              # 2 接口 (JWT)
│   │   ├── etc/seckill-api.yaml          # 端口 8809
│   │   └── internal/handler/seckill/     # 2 handler
```
