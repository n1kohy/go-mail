# 阶段 4：商品与库存服务 ✅

## 4.1 商品服务 (Product)

### Spec 文件

| 文件 | 接口数 |
|:---|:---|
| `services/product/api/desc/product.api` | 2（商品列表/详情，全部公开） |
| `services/product/rpc/product.proto` | 2（GetProduct/GetProductsByIds） |

### Model

`db_product` 数据库，3 张表：

| Model 文件 | 关键方法 |
|:---|:---|
| `productmodel.go` | FindOne / FindAll / FindListByCategoryId / FindByIds / CountAll / CountByCategoryId |
| `productskumodel.go` | FindByProductId |
| `categorymodel.go` | FindOne（带 Redis 缓存） |

### 配置

| 服务 | 端口 | 数据库 |
|:---|:---|:---|
| Product API | 8803 | db_product |
| Product RPC | 9902 | db_product |

### 业务逻辑

| Logic | 核心流程 |
|:---|:---|
| **ProductList** | 分类筛选 + 分页查询 + 首个 SKU 价格展示 |
| **ProductDetail** | SPU + 分类名称 + SKU 列表联查 |
| **GetProduct (RPC)** | 按 ID 查询，gRPC status 错误处理 |
| **GetProductsByIds (RPC)** | 批量 ID 查询 |

---

## 4.2 库存服务 (Inventory)

**仅 RPC**，无 HTTP API。

### Spec 文件

`services/inventory/rpc/inventory.proto` — 3 个 RPC 方法

### Model

`db_inventory` 数据库，1 张表：

| Model 文件 | 关键方法 |
|:---|:---|
| `stockmodel.go` | FindOneBySkuId / **DeductStock（乐观锁）** / RollbackStock |

### 配置

| 服务 | 端口 | 数据库 |
|:---|:---|:---|
| Inventory RPC | 9903 | db_inventory |

### 业务逻辑

| Logic | 核心流程 |
|:---|:---|
| **GetStock** | 查询 SKU 库存 |
| **DeductStock** | 乐观锁版本校验 → available - qty / locked + qty → version + 1 |
| **RollbackStock** | available + qty / locked - qty → version + 1 |

> **乐观锁防超卖**：`WHERE available >= $1 AND version = $3`，失败返回 `codes.FailedPrecondition`

---

## 4.3 构建验证

```bash
go build ./...  # ✅ 通过
```

## 4.4 文件清单

```
services/
├── product/
│   ├── api/
│   │   ├── desc/product.api            # Spec (2 接口)
│   │   ├── etc/product-api.yaml        # 端口 8803
│   │   ├── product.go                  # 入口
│   │   └── internal/
│   │       ├── config/config.go
│   │       ├── handler/product/        # productlisthandler / productdetailhandler
│   │       ├── logic/product/          # productlistlogic / productdetaillogic
│   │       ├── svc/servicecontext.go   # 注入 3 Model
│   │       └── types/types.go          # DO NOT EDIT
│   ├── rpc/
│   │   ├── product.proto               # Spec (2 RPC)
│   │   ├── etc/product.yaml            # 端口 9902
│   │   ├── product.go
│   │   ├── product/                    # pb 生成
│   │   ├── productrpc/productrpc.go    # 客户端
│   │   └── internal/
│   │       ├── logic/                  # getproductlogic / getproductsbyidslogic
│   │       └── svc/servicecontext.go
│   └── model/
│       ├── vars.go / productmodel.go / productskumodel.go / categorymodel.go
└── inventory/
    ├── rpc/
    │   ├── inventory.proto             # Spec (3 RPC)
    │   ├── etc/inventory.yaml          # 端口 9903
    │   ├── inventory.go
    │   ├── inventory/                  # pb 生成
    │   ├── inventoryrpc/inventoryrpc.go # 客户端
    │   └── internal/
    │       ├── logic/                  # getstocklogic / deductstocklogic / rollbackstocklogic
    │       └── svc/servicecontext.go
    └── model/
        ├── vars.go / stockmodel.go
```
