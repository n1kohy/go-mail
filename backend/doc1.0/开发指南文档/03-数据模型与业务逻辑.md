# é˜¶æ®µ 3ï¼šæ•°æ®æ¨¡å‹ä¸ä¸šåŠ¡é€»è¾‘ âœ…

## é…ç½®

ä¸‰ä¸ªæœåŠ¡çš„é…ç½®æ–‡ä»¶ï¼ˆ`etc/*.yaml`ï¼‰ï¼š

| æœåŠ¡ | ç«¯å£ | å…³é”®é…ç½® |
|:---|:---|:---|
| User API | 8801 | DataSource + Cache + Auth |
| User RPC | 9901 | DataSource + Cache |
| Auth API | 8802 | DataSource + Cache + Auth |

```yaml
# é…ç½®æ¨¡æ¿
Name: user-api
Host: 0.0.0.0
Port: 8801
DataSource: "postgres://postgres:123456@localhost:5432/db_user?sslmode=disable"
Cache:
  - Host: localhost:6379
Auth:
  AccessSecret: "go-mail-jwt-secret-2026"
  AccessExpire: 86400
```

```go
// Config ç»“æ„
type Config struct {
    rest.RestConf
    DataSource string
    Cache      cache.CacheConf
    Auth struct {
        AccessSecret string
        AccessExpire int64
    }
}
```

## ServiceContext

```go
func NewServiceContext(c config.Config) *ServiceContext {
    conn := sqlx.NewSqlConn("postgres", c.DataSource)  // æ³¨æ„: "postgres" é "mysql"
    return &ServiceContext{
        Config:           c,
        UserModel:        model.NewUserModel(conn, c.Cache),
        UserAddressModel: model.NewUserAddressModel(conn, c.Cache),
    }
}
```

## PostgreSQL Model

| æ–‡ä»¶ | è¯´æ˜ |
|:---|:---|
| `model/vars.go` | `ErrNotFound = sqlx.ErrNotFound` |
| `model/usermodel.go` | `$1` å ä½ç¬¦ + Redis ç¼“å­˜ |
| `model/useraddressmodel.go` | `FindByUserId` è‡ªå®šä¹‰æŸ¥è¯¢ |

**æ ¸å¿ƒè¦ç‚¹**ï¼š
```go
// âœ… PostgreSQL: $1 å ä½ç¬¦ + åŒå¼•å·è¡¨å
query := `INSERT INTO "user" (username, password, mobile) VALUES ($1, $2, $3)`

// âœ… æ— ç¼“å­˜æŸ¥è¯¢ç”¨ QueryRowNoCacheCtxï¼ˆé QueryRowIndexCtxï¼‰
err := m.QueryRowNoCacheCtx(ctx, &resp, query, username)

// âœ… å¤šè¡Œæ— ç¼“å­˜æŸ¥è¯¢
err := m.QueryRowsNoCacheCtx(ctx, &list, query, userId)
```

## ä¸šåŠ¡é€»è¾‘

### User API â€” 4 ä¸ª Logic

| Logic | æ ¸å¿ƒæµç¨‹ |
|:---|:---|
| **Register** | å”¯ä¸€æ€§æ ¡éªŒ â†’ bcrypt â†’ æ’å…¥ â†’ è¿”å› userId |
| **GetUserInfo** | JWT userId â†’ æŸ¥åº“ â†’ æ‰‹æœºå·è„±æ• `138****8000` |
| **AddAddress** | JWT userId â†’ å†™ user_address â†’ è¿”å› ID |
| **GetAddressList** | JWT userId â†’ æŸ¥åœ°å€ â†’ é»˜è®¤ä¼˜å…ˆæ’åº |

> `@server(group: user)` å¯¼è‡´åŒ…åä¸º `package user`ï¼ˆé `package logic`ï¼‰

### Auth API â€” 3 ä¸ª Logic

| Logic | æ ¸å¿ƒæµç¨‹ |
|:---|:---|
| **Login** | æŸ¥ç”¨æˆ· â†’ `utils.CheckPassword(hash, plain)` â†’ JWT ç­¾å‘ |
| **Refresh** | ğŸ“‹ å¾…å®ç°ï¼ˆéœ€ Redis å­˜å‚¨ refresh_tokenï¼‰ |
| **Logout** | ğŸ“‹ å¾…å®ç°ï¼ˆéœ€ Redis token é»‘åå•ï¼‰ |

### User RPC â€” 3 ä¸ªæ–¹æ³•

| æ–¹æ³• | é”™è¯¯å¤„ç† |
|:---|:---|
| `GetUser(id)` | `status.Error(codes.NotFound, ...)` |
| `GetUserByMobile(mobile)` | `status.Error(codes.NotFound, ...)` |
| `GetUserByUsername(username)` | `status.Error(codes.NotFound, ...)` |

> RPC å±‚ç”¨ gRPC status codesï¼›API å±‚ç”¨ `xerr.NewCodeError()`

## Handler ç»Ÿä¸€å“åº”

```diff
- httpx.OkJsonCtx(r.Context(), w, resp)
+ response.Response(w, resp, err)    // â†’ {code, msg, data}
```

7 ä¸ª Handler å·²å…¨éƒ¨æ”¹é€ ã€‚

## æ–‡ä»¶æ¸…å•

```
services/
â”œâ”€â”€ auth/api/
â”‚   â”œâ”€â”€ desc/auth.api          # Spec (3 æ¥å£)
â”‚   â”œâ”€â”€ etc/auth-api.yaml      # ç«¯å£ 8802
â”‚   â””â”€â”€ internal/
â”‚       â”œâ”€â”€ config/config.go
â”‚       â”œâ”€â”€ handler/auth/      # loginhandler / refreshhandler / logouthandler
â”‚       â”œâ”€â”€ logic/auth/        # loginlogic / refreshlogic / logoutlogic
â”‚       â”œâ”€â”€ svc/servicecontext.go
â”‚       â””â”€â”€ types/types.go     # DO NOT EDIT
â”œâ”€â”€ user/api/
â”‚   â”œâ”€â”€ desc/user.api          # Spec (4 æ¥å£)
â”‚   â”œâ”€â”€ etc/user-api.yaml      # ç«¯å£ 8801
â”‚   â””â”€â”€ internal/
â”‚       â”œâ”€â”€ handler/user/      # register / getuserinfo / addaddress / getaddresslist
â”‚       â”œâ”€â”€ logic/user/        # åŒå logic æ–‡ä»¶
â”‚       â””â”€â”€ ...
â”œâ”€â”€ user/model/
â”‚   â”œâ”€â”€ vars.go / usermodel.go / useraddressmodel.go
â””â”€â”€ user/rpc/
    â”œâ”€â”€ user.proto             # Spec (3 RPC)
    â”œâ”€â”€ etc/user.yaml          # ç«¯å£ 9901
    â”œâ”€â”€ userrpc/userrpc.go     # å®¢æˆ·ç«¯ï¼ˆå…¶ä»–æœåŠ¡å¼•ç”¨ï¼‰
    â””â”€â”€ internal/logic/        # getuserlogic / getuserbymobile / getuserbyusername
```

```bash
go build ./...  # âœ… é€šè¿‡
```
