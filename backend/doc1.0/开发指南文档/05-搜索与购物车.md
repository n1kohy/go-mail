# 阶段 5：搜索与购物车服务 ✅

## 5.1 搜索服务 (Search) — 仅 API

### Spec 文件

`services/search/api/desc/search.api` — 3 接口（全部公开）

### 配置

| 服务 | 端口 | 数据库 |
|:---|:---|:---|
| Search API | 8804 | db_product（复用商品库搜索） |

### 业务逻辑

| Logic | 核心流程 |
|:---|:---|
| **SearchProduct** | PostgreSQL `ILIKE` 模糊搜索 + 分页 + LEFT JOIN 取 SKU 最低价 |
| **SearchSuggest** | `ILIKE` 前缀匹配返回前 10 条商品名称 |
| **SearchHot** | 初版静态热搜词（后续接入 Redis ZREVRANGE） |

> 初版直接查 db_product，后续替换为 Elasticsearch

---

## 5.2 购物车服务 (Cart) — API + RPC

### Spec 文件

| 文件 | 接口数 |
|:---|:---|
| `services/cart/api/desc/cart.api` | 4（加入/列表/更新/删除，全部 JWT） |
| `services/cart/rpc/cart.proto` | 2（GetCartItems/ClearCartItems） |

### Model

`db_cart` 数据库，1 张表：

| Model 文件 | 关键方法 |
|:---|:---|
| `cartitemmodel.go` | **Upsert（ON CONFLICT 累加数量）** / FindByUserId / FindSelectedByUserId / UpdateQuantity / DeleteByUserIdAndSkuIds |

### 配置

| 服务 | 端口 | 数据库 |
|:---|:---|:---|
| Cart API | 8805 | db_cart |
| Cart RPC | 9904 | db_cart |

### 业务逻辑

#### Cart API — 4 个 Logic

| Logic | 核心流程 |
|:---|:---|
| **CartAdd** | JWT userId → Upsert（存在则累加数量） |
| **CartList** | JWT userId → 查全部 → 计算选中商品总金额 |
| **CartUpdate** | JWT userId → 更新指定 SKU 数量 |
| **CartDelete** | JWT userId → 批量删除指定 SKU |

#### Cart RPC — 2 个方法

| 方法 | 说明 | 调用方 |
|:---|:---|:---|
| `GetCartItems(userId)` | 查选中商品 | Order |
| `ClearCartItems(userId, skuIds)` | 下单后清理 | Order |

---

## 5.3 构建验证

```bash
go build ./...  # ✅ 通过
```

## 5.4 文件清单

```
services/
├── search/api/
│   ├── desc/search.api              # Spec (3 接口)
│   ├── etc/search-api.yaml          # 端口 8804
│   └── internal/
│       ├── handler/search/          # searchproduct / searchsuggest / searchhot
│       ├── logic/search/            # 同名 logic
│       └── svc/servicecontext.go    # 复用 Product Model
├── cart/api/
│   ├── desc/cart.api                # Spec (4 接口 JWT)
│   ├── etc/cart-api.yaml            # 端口 8805
│   └── internal/
│       ├── handler/cart/            # cartadd / cartlist / cartupdate / cartdelete
│       ├── logic/cart/              # 同名 logic
│       └── svc/servicecontext.go
├── cart/rpc/
│   ├── cart.proto                   # Spec (2 RPC)
│   ├── etc/cart.yaml                # 端口 9904
│   ├── cartrpc/cartrpc.go           # 客户端
│   └── internal/logic/              # getcartitemslogic / clearcartitemslogic
└── cart/model/
    ├── vars.go / cartitemmodel.go
```
