# 阶段 9：Order 多 RPC 集成 + 系统优化 ✅

## 9.1 Order API → 4 RPC 客户端注入

### Config 变更

```go
type Config struct {
    rest.RestConf
    DataSource       string
    Cache            cache.CacheConf
    Auth             struct { ... }
    CartRpcConf      zrpc.RpcClientConf  // Cart RPC (9904)
    ProductRpcConf   zrpc.RpcClientConf  // Product RPC (9902)
    InventoryRpcConf zrpc.RpcClientConf  // Inventory RPC (9903)
    PromotionRpcConf zrpc.RpcClientConf  // Promotion RPC (9905)
}
```

### ServiceContext 注入

```go
CartRpc:      cartrpc.NewCartRpc(zrpc.MustNewClient(c.CartRpcConf))
ProductRpc:   productrpc.NewProductRpc(zrpc.MustNewClient(c.ProductRpcConf))
InventoryRpc: inventoryrpc.NewInventoryRpc(zrpc.MustNewClient(c.InventoryRpcConf))
PromotionRpc: promotionrpc.NewPromotionRpc(zrpc.MustNewClient(c.PromotionRpcConf))
```

---

## 9.2 CreateOrder 完整跨服务调用链

```
步骤 1: Cart RPC → GetCartItems        (获取购物车选中商品)
步骤 2: 计算总金额                       (购物车商品价格 × 数量)
步骤 3: Promotion RPC → CalculateDiscount (计算优惠，校验门槛)
步骤 4: Inventory RPC → DeductStock     (逐个扣减库存，乐观锁)
步骤 5: 写入 order_master + order_item   (生成雪花订单号 SN...)
步骤 6: Promotion RPC → UseCoupon       (核销优惠券)
步骤 7: Cart RPC → ClearCartItems       (清理已下单商品)
```

### 失败补偿

| 失败点 | 补偿操作 |
|:---|:---|
| 步骤 5 写入失败 | `rollbackStock(items)` 回滚已扣减库存 |
| 步骤 4 扣减失败 | 立即返回"库存不足"，前面已扣减的 SKU 无法自动回滚（后续需 Saga 模式） |

---

## 9.3 CancelOrder 库存回滚

```
CancelOrder 流程:
  1. 验证订单归属 + 状态(仅待支付=0可取消)
  2. 更新订单状态为已取消(4)
  3. 查询订单明细
  4. Inventory RPC → RollbackStock (逐个回滚库存)
```

---

## 9.4 跨服务调用完整关系图

```
                    ┌──────────────┐
                    │  Auth API    │
                    │  (8802)      │
                    └──────┬───────┘
                           │ User RPC
                    ┌──────┴───────┐
                    │  User RPC    │
                    │  (9901)      │
                    └──────────────┘

┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
│Cart RPC  │   │Product   │   │Inventory │   │Promotion │
│(9904)    │   │RPC(9902) │   │RPC(9903) │   │RPC(9905) │
└────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘
     │              │              │              │
     └──────────────┴──────────────┴──────────────┘
                           │
                    ┌──────┴───────┐
                    │  Order API   │ ← CreateOrder 调用 4 个 RPC
                    │  (8807)      │ ← CancelOrder 调用 Inventory RPC
                    └──────┬───────┘
                           │ Order RPC (9906)
              ┌────────────┼────────────┐
              │            │            │
       ┌──────┴──┐  ┌──────┴──┐  ┌─────┴───────┐
       │Payment  │  │Logistics│  │ Search/Cart  │
       │API(8808)│  │API(8810)│  │ Seckill API  │
       └─────────┘  └─────────┘  └──────────────┘
```

---

## 9.5 修改文件清单

| 文件 | 变更 |
|:---|:---|
| `order/api/internal/config/config.go` | 新增 4 个 `RpcClientConf` |
| `order/api/internal/svc/servicecontext.go` | 注入 4 个 RPC 客户端 |
| `order/api/etc/order-api.yaml` | 新增 4 个 RPC Endpoints |
| `order/api/internal/logic/order/createorderlogic.go` | **完整重写**——7步跨服务链 |
| `order/api/internal/logic/order/cancelorderlogic.go` | **优化**——库存回滚 |

## 9.6 构建验证

```bash
go build ./...  # ✅ 通过
```
