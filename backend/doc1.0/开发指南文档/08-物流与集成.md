# 阶段 8：物流服务 + 跨服务 RPC 集成 ✅

## 8.1 物流服务 (Logistics) — API + RPC

### Spec 文件

| 文件 | 接口数 |
|:---|:---|
| `services/logistics/api/desc/logistics.api` | 2（发货+物流详情，JWT） |
| `services/logistics/rpc/logistics.proto` | 1（GetLogisticsByOrderId） |

### Model

`db_logistics` 数据库，1 张表：

| Model 文件 | 关键方法 |
|:---|:---|
| `shippingordermodel.go` | Insert / FindByOrderId / UpdateStatus |

### 配置

| 服务 | 端口 | 数据库 | 跨服务 |
|:---|:---|:---|:---|
| Logistics API | 8810 | db_logistics | → Order RPC (9906) |
| Logistics RPC | 9908 | db_logistics | — |

### 业务逻辑

| Logic | 核心流程 |
|:---|:---|
| **Ship** | **Order RPC 验证状态(已支付)** → 创建物流记录 → **Order RPC 更新已发货(2)** |
| **LogisticsDetail** | 按订单号查物流信息 |
| **GetLogisticsByOrderId (RPC)** | 供 Order 等服务调用 |

---

## 8.2 跨服务 RPC 集成

### Payment API → Order RPC

| 文件 | 变更 |
|:---|:---|
| `payment/api/internal/config/config.go` | 新增 `OrderRpcConf` |
| `payment/api/internal/svc/servicecontext.go` | 注入 `OrderRpc` 客户端 |
| `payment/api/etc/payment-api.yaml` | 新增 `OrderRpcConf.Endpoints` |
| `payment/api/internal/logic/payment/paycallbacklogic.go` | **回调后调用 Order RPC → UpdateOrderStatus(已支付)** |

### Logistics API → Order RPC

| 文件 | 变更 |
|:---|:---|
| `logistics/api/internal/config/config.go` | 新增 `OrderRpcConf` |
| `logistics/api/internal/svc/servicecontext.go` | 注入 `OrderRpc` 客户端 |
| `logistics/api/etc/logistics-api.yaml` | 新增 `OrderRpcConf.Endpoints` |
| `logistics/api/internal/logic/logistics/shiplogic.go` | **验证订单→创建物流→更新订单已发货** |

### 跨服务调用总结

```
Payment 回调 ──→ Order RPC (UpdateOrderStatus: 已支付)
Logistics 发货 ──→ Order RPC (GetOrder: 验证状态)
              ──→ Order RPC (UpdateOrderStatus: 已发货)
```

> **Order API → 多 RPC 调用**（Cart/Product/Inventory/Promotion）留作后续阶段集成，需处理分布式事务。

---

## 8.3 构建验证

```bash
go build ./...  # ✅ 通过
```

## 8.4 文件清单

```
services/
├── logistics/
│   ├── api/
│   │   ├── desc/logistics.api             # 2 接口 (JWT)
│   │   ├── etc/logistics-api.yaml         # 端口 8810 + OrderRpcConf
│   │   └── internal/handler/logistics/    # 2 handler
│   ├── rpc/
│   │   ├── logistics.proto                # 1 RPC
│   │   ├── etc/logistics.yaml             # 端口 9908
│   │   └── internal/logic/               # 1 logic
│   └── model/
│       ├── shippingordermodel.go / vars.go
├── payment/
│   └── api/ (已修改: config + svc + yaml + paycallback logic)
```
