# 附录：速查参考

## Spec-First 工作流

```
1. 编写 .api 文件 (syntax="v1" + info + type + @server)
       ↓
2. goctl api go -api desc/xxx.api -dir . -style gozero
       ↓
3. 修改 Config       → DataSource / Cache / Auth
4. 修改 ServiceContext → 注入 Model / RPC Client
5. 编写 Logic         → 完整业务实现（禁止空 stub）
6. 修改 Handler       → response.Response(w, resp, err)
       ↓
7. go build ./...     → 验证编译
```

## goctl 命令

```bash
# API 生成
goctl api go -api desc/service.api -dir . -style gozero

# RPC 生成
goctl rpc protoc service.proto --go_out=. --go-grpc_out=. --zrpc_out=. -style gozero

# PostgreSQL Model 生成
goctl model pg datasource -url="postgres://..." -table="xxx" -dir ./model -c -style gozero

# 格式化 .api
goctl api format --dir desc/
```

## 端口分配

| 服务 | API 端口 | RPC 端口 |
|:---|:---|:---|
| User | 8801 | 9901 |
| Auth | 8802 | — |
| Product | 8803 | 9902 |
| Inventory | — | 9903 |
| Search | 8804 | — |
| Cart | 8805 | 9904 |
| Promotion | 8806 | 9905 |
| Order | 8807 | 9906 |
| Payment | 8808 | 9907 |
| Seckill | 8809 | — |
| Logistics | 8810 | 9908 |

## 跨服务 RPC 调用关系

| 调用方 | 被调方 | 场景 |
|:---|:---|:---|
| Payment API | Order RPC | 支付回调 → 更新订单已支付 |
| Logistics API | Order RPC | 验证订单 + 更新订单已发货 |
| Order API (待集成) | Cart/Product/Inventory/Promotion RPC | 创建订单完整流程 |

## 错误处理

```go
// API 层 → xerr
return nil, xerr.NewCodeErrorMsg(xerr.BadRequest, "用户名已被注册")

// RPC 层 → gRPC status
return nil, status.Error(codes.NotFound, "用户不存在")
```

## go-zero v1.9.4 兼容性

```go
// ❌ ExecCtx 回调签名不匹配
m.ExecCtx(ctx, func(ctx context.Context, conn sqlx.SqlConn) (any, error) { ... }, key)

// ✅ 改用 ExecNoCacheCtx + 手动删缓存
m.ExecNoCacheCtx(ctx, query, args...)
m.DelCacheCtx(ctx, key)
```

## 跨服务 RPC 注入模式

```go
// 1. Config 添加 RPC 地址
type Config struct {
    rest.RestConf
    OrderRpcConf zrpc.RpcClientConf
}

// 2. ServiceContext 注入客户端
OrderRpc: orderrpc.NewOrderRpc(zrpc.MustNewClient(c.OrderRpcConf))

// 3. YAML 配置
OrderRpcConf:
  Endpoints:
    - localhost:9906

// 4. Logic 中调用
resp, err := l.svcCtx.OrderRpc.GetOrder(l.ctx, &orderrpc.GetOrderReq{...})
```

## 知识库索引

| # | 文件 | 内容 |
|---|:---|:---|
| 1 | `.cursorrules/workflows.md` | 工作流 |
| 2 | `.cursorrules/tools.md` | 工具用法 |
| 3 | `.cursorrules/patterns.md` | 代码模式 |
| 4 | `zero-skills/references/rest-api-patterns.md` | REST API |
| 5 | `zero-skills/references/rpc-patterns.md` | RPC |
| 6 | `zero-skills/references/database-patterns.md` | 数据库 |
| 7 | `zero-skills/references/resilience-patterns.md` | 弹性模式 |
| 8 | `zero-skills/troubleshooting/common-issues.md` | 常见问题 |
